<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Users</title>
    <style>
        /* ... (existing styles) ... */
    </style>
</head>
<body>
    <header>
        <h1>Manage Users</h1>
    </header>
    <div class="container">
        <div class="main-content">
            <div class="section">
                <h2>Manage Users</h2>
                <button class="btn" id="addUserBtn">Add User</button>
                <button class="btn" id="deleteUserBtn">Delete User</button>
            </div>

            <!-- Add User Form -->
            <div class="section" id="addUserSection" style="display: none;">
                <h2>Add Patient History</h2>
                <form id="addUserForm">
                    <!-- ... (existing form fields) ... -->
                    <div class="form-group">
                        <button type="submit">Save and Export</button>
                    </div>
                </form>
            </div>

            <!-- Delete User Section -->
            <div class="section" id="deleteUserSection" style="display: none;">
                <h2>Delete User</h2>
                <ul class="user-list" id="userList">
                    <!-- User list will be dynamically populated -->
                </ul>
            </div>
        </div>
    </div>
    <script>
        // Show and hide sections
        document.getElementById('addUserBtn').addEventListener('click', function() {
            document.getElementById('addUserSection').style.display = 'block';
            document.getElementById('deleteUserSection').style.display = 'none';
            loadFormData(); // Load data if available
        });

        document.getElementById('deleteUserBtn').addEventListener('click', function() {
            document.getElementById('addUserSection').style.display = 'none';
            document.getElementById('deleteUserSection').style.display = 'block';
            fetchUsers(); // Load user list
        });

        // Load form data from local storage
        function loadFormData() {
            const formData = JSON.parse(localStorage.getItem('userFormData'));
            if (formData) {
                for (const key in formData) {
                    const element = document.getElementById(key);
                    if (element) element.value = formData[key];
                }
            }
        }

        // Save form data to local storage
        function saveFormData() {
            const formData = {
                name: document.getElementById('name').value,
                emergencyContact: document.getElementById('emergencyContact').value,
                age: document.getElementById('age').value,
                gender: document.getElementById('gender').value,
                dob: document.getElementById('dob').value,
                bloodGroup: document.getElementById('bloodGroup').value,
                insuranceId: document.getElementById('insuranceId').value,
                pcpName: document.getElementById('pcpName').value,
                pcpNumber: document.getElementById('pcpNumber').value,
                maritalStatus: document.getElementById('maritalStatus').value,
                medicalProxyNumber: document.getElementById('medicalProxyNumber').value,
                policyName: document.getElementById('policyName').value,
                employer: document.getElementById('employer').value,
                employerAddress: document.getElementById('employerAddress').value,
                policyId: document.getElementById('policyId').value,
                chronicConditions: document.getElementById('chronicConditions').value,
                chronicMedications: document.getElementById('chronicMedications').value,
                surgicalHistory: document.getElementById('surgicalHistory').value,
                congenitalDiseaseHistory: document.getElementById('congenitalDiseaseHistory').value,
                familyHistory: document.getElementById('familyHistory').value,
                socialHistory: document.getElementById('socialHistory').value,
                vaccineHistory: document.getElementById('vaccineHistory').value,
                foodAllergies: document.getElementById('foodAllergies').value,
                materialAllergies: document.getElementById('materialAllergies').value,
                medicationAllergies: document.getElementById('medicationAllergies').value,
                doctorNote: document.getElementById('doctorNote').value
            };
            localStorage.setItem('userFormData', JSON.stringify(formData));
        }

        // Handle form submission
        document.getElementById('addUserForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            saveFormData();

            // Get form data
            const formData = {
                name: document.getElementById('name').value,
                emergencyContact: document.getElementById('emergencyContact').value,
                age: document.getElementById('age').value,
                gender: document.getElementById('gender').value,
                dob: document.getElementById('dob').value,
                bloodGroup: document.getElementById('bloodGroup').value,
                insuranceId: document.getElementById('insuranceId').value,
                pcpName: document.getElementById('pcpName').value,
                pcpNumber: document.getElementById('pcpNumber').value,
                maritalStatus: document.getElementById('maritalStatus').value,
                medicalProxyNumber: document.getElementById('medicalProxyNumber').value,
                policyName: document.getElementById('policyName').value,
                employer: document.getElementById('employer').value,
                employerAddress: document.getElementById('employerAddress').value,
                policyId: document.getElementById('policyId').value,
                chronicConditions: document.getElementById('chronicConditions').value,
                chronicMedications: document.getElementById('chronicMedications').value,
                surgicalHistory: document.getElementById('surgicalHistory').value,
                congenitalDiseaseHistory: document.getElementById('congenitalDiseaseHistory').value,
                familyHistory: document.getElementById('familyHistory').value,
                socialHistory: document.getElementById('socialHistory').value,
                vaccineHistory: document.getElementById('vaccineHistory').value,
                foodAllergies: document.getElementById('foodAllergies').value,
                materialAllergies: document.getElementById('materialAllergies').value,
                medicationAllergies: document.getElementById('medicationAllergies').value,
                doctorNote: document.getElementById('doctorNote').value
            };

            // Send data to Vercel API route (that interacts with GitHub repository)
            try {
                const response = await fetch('/api/addUser', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok.');
                }

                const { userId } = await response.json();

                console.log('Form Data saved successfully');
                document.getElementById('addUserForm').reset();
                localStorage.removeItem('userFormData');

                // Redirect to user details page
                window.location.href = `/user-details/${userId}`;
            } catch (error) {
                console.error('Error:', error);
            }
        });

        // Fetch users to display in delete section
        async function fetchUsers() {
            try {
                const response = await fetch('/api/users');
                if (!response.ok) {
                    throw new Error('Network response was not ok.');
                }
                const users = await response.json();
                const userList = document.getElementById('userList');
                userList.innerHTML = '';
                users.forEach(user => {
                    const li = document.createElement('li');
                    li.textContent = `${user.name} - ID: ${user.id}`;
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn';
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.addEventListener('click', () => deleteUser(user.id, li));
                    li.appendChild(deleteBtn);
                    userList.appendChild(li);
                });
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Handle user deletion
        async function deleteUser(userId, liElement) {
            try {
                const response = await fetch(`/api/deleteUser/${userId}`, {
                    method: 'DELETE'
                });
                if (!response.ok) {
                    throw new Error('Network response was not ok.');
                }
                console.log('User deleted successfully');
                liElement.remove();
            } catch (error) {
                console.error('Error:', error);
            }
        }
    </script>
</body>
</html>
